workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(dev|stg|main)$/

stages:
  - test
  - build
  - deploy-test

# Test stage - validates dagster build before containerization
# Runs on MR only
test:
  stage: test
  tags:
    - k8s
    - docker
  image: python:3.12-slim
  variables:
    ENVIRONMENT: "dev"
    DAGSTER_HOME: "/builds"
  before_script:
    - pip install --no-cache-dir -r requirements.txt
  script:
    - python tests/test_dagster_build.py
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build stage - build and push container image
# Runs on push to dev/stg/main
build:
  stage: build
  tags:
    - k8s
    - docker
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME}"
      --destination "${CI_REGISTRY_IMAGE}:sha-${CI_COMMIT_SHORT_SHA}"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^(dev|stg|main)$/

# Deploy-test template
.deploy-test:
  stage: deploy-test
  tags:
    - k8s
    - docker
  image: alpine/k8s:1.28.3
  needs:
    - build
  before_script:
    - apk add --no-cache bash curl
  script:
    - echo "Restarting deployment to pull new image..."
    - kubectl rollout restart deployment/${DEPLOYMENT} -n ${NAMESPACE}

    - echo "Waiting for rollout to complete..."
    - kubectl rollout status deployment/${DEPLOYMENT} -n ${NAMESPACE} --timeout=180s

    - echo "Waiting for Dagster webserver to be ready..."
    - |
      SERVICE_URL="http://${SERVICE_HOST}:${SERVICE_PORT}"
      for i in $(seq 1 30); do
        HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/dagit_info" || echo "000")
        if [ "$HEALTH" = "200" ]; then
          echo "Dagster webserver health check passed!"
          break
        fi
        echo "Health check attempt $i: HTTP $HEALTH, waiting..."
        sleep 5
      done
      if [ "$HEALTH" != "200" ]; then
        echo "Health check failed after 30 attempts"
        exit 1
      fi

    - echo "Verifying Dagster definitions loaded..."
    - |
      DEFINITIONS=$(curl -s "${SERVICE_URL}/dagit_info" | grep -o '"dagster_version"' || echo "")
      if [ -z "$DEFINITIONS" ]; then
        echo "Dagster definitions not loaded properly"
        exit 1
      fi
      echo "Dagster definitions loaded successfully!"

# Deploy-test for dev
deploy-test-dev:
  extends: .deploy-test
  resource_group: dagstributor-dev
  variables:
    DEPLOYMENT: "dagster-dev"
    NAMESPACE: "media-dev"
    SERVICE_HOST: "dagster-dev.media-dev.svc.cluster.local"
    SERVICE_PORT: "3000"
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"

# Deploy-test for stg
deploy-test-stg:
  extends: .deploy-test
  resource_group: dagstributor-stg
  variables:
    DEPLOYMENT: "dagster-stg"
    NAMESPACE: "media-stg"
    SERVICE_HOST: "dagster-stg.media-stg.svc.cluster.local"
    SERVICE_PORT: "3000"
  rules:
    - if: $CI_COMMIT_BRANCH == "stg"

# Deploy-test for prod
deploy-test-prod:
  extends: .deploy-test
  resource_group: dagstributor-prod
  variables:
    DEPLOYMENT: "dagster-prod"
    NAMESPACE: "media-prod"
    SERVICE_HOST: "dagster-prod.media-prod.svc.cluster.local"
    SERVICE_PORT: "3000"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
